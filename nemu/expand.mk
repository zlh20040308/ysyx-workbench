
# Sanity check
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
#
# Automatically generated file; DO NOT EDIT.
# NEMU Configuration Menu
#
CONFIG_AUDIO_CTL_MMIO=0xa0000200
CONFIG_DIFFTEST_REF_NAME="spike"
CONFIG_ENGINE="interpreter"
CONFIG_WATCHPOINT=y
CONFIG_VGA_SIZE_400x300=y
CONFIG_VGA_SHOW_SCREEN=y
CONFIG_PC_RESET_OFFSET=0
CONFIG_RTC_MMIO=0xa0000048
CONFIG_FTRACE_COND="true"
CONFIG_DIFFTEST_REF_SPIKE=y
CONFIG_TARGET_NATIVE_ELF=y
CONFIG_HAS_AUDIO=y
CONFIG_MSIZE=0x8000000
CONFIG_CC_O2=y
CONFIG_DEVICE=y
CONFIG_HAS_KEYBOARD=y
CONFIG_MODE_SYSTEM=y
CONFIG_ITRACE=y
CONFIG_DIFFTEST=y
CONFIG_HAS_SERIAL=y
CONFIG_ISA_riscv=y
CONFIG_HAS_DISK=y
CONFIG_TRACE_END=10000
CONFIG_FB_ADDR=0xa1000000
CONFIG_HAS_VGA=y
CONFIG_HAS_TIMER=y
CONFIG_DISK_CTL_MMIO=0xa0000300
CONFIG_MBASE=0x80000000
CONFIG_TIMER_GETTIMEOFDAY=y
CONFIG_FTRACE=y
CONFIG_ENGINE_INTERPRETER=y
CONFIG_CC_OPT="-O2"
CONFIG_SERIAL_MMIO=0xa00003f8
CONFIG_RT_CHECK=y
CONFIG_I8042_DATA_MMIO=0xa0000060
CONFIG_ITRACE_COND="true"
CONFIG_SB_SIZE=0x10000
CONFIG_CC="gcc"
CONFIG_DIFFTEST_REF_PATH="tools/spike-diff"
CONFIG_CC_DEBUG=y
CONFIG_TRACE_START=0
CONFIG_DISK_IMG_PATH=""
CONFIG_CC_GCC=y
CONFIG_SB_ADDR=0xa1200000
CONFIG_TRACE=y
CONFIG_ISA="riscv32"
CONFIG_VGA_CTL_MMIO=0xa0000100
CONFIG_PMEM_GARRAY=y

deps_config := \
	src/device/Kconfig \
	src/memory/Kconfig \
	src/isa/riscv32/Kconfig \
	/home/feng/OS/ysyx-workbench/nemu/Kconfig

include/config/auto.conf: \
	$(deps_config)


$(deps_config): ;

remove_quote = $(patsubst "%",%,$(1))

# Extract variabls from menuconfig
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
$(info GUEST_ISA = $(GUEST_ISA))
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
$(info ENGINE = $(ENGINE))
NAME    = $(GUEST_ISA)-nemu-$(ENGINE)
$(info NAME = $(NAME))
# Include all filelist.mk to merge file lists
FILELIST_MK = $(shell find -L ./src -name "filelist.mk")
$(info FILELIST_MK = $(FILELIST_MK))

include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
# $(info DIRS-BLACKLIST-y = $(DIRS-BLACKLIST-y))

SRCS-BLACKLIST-y += $(SRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.c")
# $(info SRCS-BLACKLIST-y = $(SRCS-BLACKLIST-y))

SRCS-y += $(shell find -L $(DIRS-y) -name "*.c")
SRCS = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))

# Extract compiler and options from menuconfig
CC = $(call remove_quote,$(CONFIG_CC))
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)
# CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
CFLAGS_ITRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
CFLAGS_MTRACE += -DMTRACE_COND=$(if $(CONFIG_MTRACE_COND),$(call remove_quote,$(CONFIG_MTRACE_COND)),true)
CFLAGS_FTRACE += -DFTRACE_COND=$(if $(CONFIG_FTRACE_COND),$(call remove_quote,$(CONFIG_FTRACE_COND)),true)
# CFLAGS_TRACE += $(CFLAGS_ITRACE) $(CFLAGS_MTRACE) 

# 初始化 CFLAGS_TRACE
CFLAGS_TRACE :=

# 根据命令行传递的参数更新 CFLAGS_TRACE
# ifdef CONFIG_ITRACE_COND
CFLAGS_TRACE += $(CFLAGS_ITRACE)
# endif

ifdef CONFIG_MTRACE_COND
CFLAGS_TRACE += $(CFLAGS_MTRACE)
endif

ifdef CONFIG_FTRACE_COND
CFLAGS_TRACE += $(CFLAGS_FTRACE)
endif

# make ITRACE=1 MTRACE=1

CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
LDFLAGS += $(CFLAGS_BUILD)

# Include rules for menuconfig
include $(NEMU_HOME)/scripts/config.mk

ifdef CONFIG_TARGET_AM
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)
else
# Include rules to build NEMU
include $(NEMU_HOME)/scripts/native.mk
endif
